---
title: "ADS 506 Group Project"
author: "Andrew Abeles"
date: "11/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(plotly)
library(astsa)
library(tseries)
library(vars)
library(fastDummies)
library(forecast)
```

```{r}
# load dataset
airquality <- read.csv('SD_airquality_2016-2020.csv')
```


```{r}
# data summary
summary(airquality)
``` 

```{r}
# data visualizations (convert Date into date data type first)
airquality$Date <- as.Date(airquality$Date, format="%m/%d/%Y")

# looking at PM2.5 across all five years
firstfigure <- airquality %>%
  ggplot( aes(x=Date, y=PM2.5.AQI.Value)) +
  geom_area(fill='darkblue', alpha=0.5) +
  geom_line(color='darkblue') +
  ylab('PM 2.5 AQI Value') + 
  ggtitle('PM 2.5 AQI Data from 2016-2020') +
  theme(plot.title=element_text(size=14, face="bold"), 
        axis.title.y=element_text(size=12, face="bold"),
        axis.title.x=element_text(size=12, face="bold"))

firstfigure <- ggplotly(firstfigure)
firstfigure
```

# OBSERVATIONS:
# - quick observations show that many peak PM2.5 readings occur in Q4 of the year
# - interestingly, some of the lowest readings occur around MAR/APR
# - sharp decrease in PM2.5 readings in MAR 2020 (possibly related to COVID lockdowns?)
# - max PM2.5 reading from SEP-OCT 2020 (coinciding with fires)

# year comparisons of PM2.5
# add additional columns for year and day of the year

```{r}
airquality <- transform(airquality,
                        Year = format(Date, '%Y'),
                        DayOfYear = as.numeric(format(Date, '%j')))
```

```{r}
secondfigure <- airquality %>%
  ggplot( aes(x=DayOfYear, y=PM2.5.AQI.Value, group=Year, colour=Year)) +
  geom_point() + 
  geom_line() +
  ylab('PM 2.5 AQI Value') + 
  ggtitle('PM 2.5 AQI Data - Year Comparisons') +
  theme(plot.title=element_text(size=14, face="bold"), 
        axis.title.y=element_text(size=12, face="bold"),
        axis.title.x=element_text(size=12, face="bold"))

secondfigure <- ggplotly(secondfigure)
secondfigure
```

# OBSERVATIONS:
# - 2016 has erratic readings during Q1, including both highest and lowest PM2.5 of that year
# - 2017 has peak readings during last two months of year
# - 2018 has peaks around JUL and from DEC-FEB
# - 2019 peaks around OCT, but has noticeably less variation in spikes compared to previous years
# - 2020 has the biggest range, with the lowest of the 5 year readings occurring MAR2020 and the highest occuring SEP2020
# - 2020 has a general trend upwards as year progresses (random walk?)
# majority of PM2.5 readings occur between 50-100

Let's create a time series object for the daily PM2.5 data. 
```{r}
PM2.5 <- ts(
  airquality$PM2.5.AQI.Value,
  start = c(2016, 1), # the series starts on the 1st day of 2016
  frequency = 365.25 # number of days per year, accounting for leap years 
)
PM2.5
```

```{r}
# Augmented Dickey-Fuller test 
adf.test(PM2.5)
```

The p-value is 0.01, so we can reject the null hypothesis that the time series has a unit root in favor of the alternative hypothesis that the time series is stationary. 

```{r}
# Decompose time series into trend, seasonality, and noise 
PM2.5_comps <- decompose(PM2.5)
plot(PM2.5_comps)
```

The ADF test suggested the series is stationary; however, the decomposition reveals an upward trend and annual seasonality. 

```{r}
# ACF and PACF plots (lag=365 selected to represent a year)
acf2(PM2.5, 365.25, main='ACF & PACF')
```

The autocorrelation at lag 1 is very strong. The ACF tails off, while the PACF cuts off after lag 1, which suggests an AR(1) model. Let's try it out. 

```{r}
# AR(1) model 
sarima(PM2.5, p=1, d=0, q=0)
```

There are some problems with this model. The tail ends of the residuals deviate quite significantly from the normal distribution, according to the Q-Q plot. Furthermore, the p values of the Ljung-Box statistic are all under .05, which suggests autocorrelation within the residuals.

On the other hand, we can search for the optimal lag length using AIC.
# AIC

```{r}
VARselect(PM2.5,lag.max=50, type="const")
```

The optimal lag length is 19 by AIC.
It is because ACF and PACF plots suggest the series follows ARMA(p, 0) for some order p, I looped through the estimation AR(p) with p = 1 to 25, and the A(p=19) has the smallest AIC. A better model has a smaller AIC (and also smaller BIC)

```{r}
arima(PM2.5, order=c(19, 0, 0))
```

The diagnostic plots for AR(19) show that the residuals have no significant autocorrelations, follow roughly normal, and all Ljung-Box statistics are larger than the threshold p-value. AR(19) seems to track the series well with the proper residuals.This model has AIC of 14075.71.

# Seasonal ARIMA

The decomposition of the time series suggests that there is a daily seaonality in a year. However, `sarima` does not allow for the seasonality of more than 350 frequency. Note that `S = 7` means that a weekly pattern and `S = 30` means a monthly patter. We try to see if a model with  monthly (seasonal) pattern works, and it does not.


```{r}
sarima(PM2.5,
       p = 1, d = 0, q = 1, P = 0, 
       D = 1, Q = 0, S = 365.25)
```

We can manually examine yearly lag airquailty obtained by taking a difference with 365th lagged term.

```{r}
yearly_lagged_PM2.5 <- diff(PM2.5, lag = 365)
```


```{r}
acf2(yearly_lagged_PM2.5, max.lag=100)
```

ACF and PACF from the seanality removed series still suggest that the the PM2.5 follows AR(p) of some order p

```{r}
VARselect(yearly_lagged_PM2.5, lag.max=50, type="const")
```

The AIC tells that the seasonality removed series follows AR(p) of order only p = 5 instead of 19,

```{r}
arima(yearly_lagged_PM2.5, order=c(5, 0, 0))
```
This model ARIMA has a AIC of 12240.69 and the best model so far.

# TBATS model

```{r}
fit <- tbats(PM2.5)
fit
fit$AIC 
```
Creating BATS model, however in that model, the AIC is a lot bigger than the AR(19) with seasonality taken into account. BATS model is more generalized version of ARIMA just like ARMA is a generalization of AR and ARIMA is a generalization of ARMA. 

BATS choose ARMA(2,1) but has a rather larger AIC = 22551.15.





y <- msts(PM2.5, seasonal.periods=c(7,30.4375,365.25))
fit <- tbats(y)
fit
